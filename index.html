<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merkur Specijali</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="injury-module.js"></script>
    <script src="lineup-module.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Accessibility Improved Colors */
            --bg-color: #E0E5EC;
            --primary-color: #4A65A0; /* Darker blue for AA contrast (4.55:1) */
            --primary-light: #7A92C8; 
            --success-color: #2E7D32; /* Darker green */
            --text-color: #5A6472;
            --text-color-dark: #3D4450;
            --shadow-light: rgba(255, 255, 255, 0.9);
            --shadow-dark: #A3B1C6;
            --border-color: rgba(163, 177, 198, 0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            /* Iridescent Gradients */
            --primary-gradient: linear-gradient(145deg, #82a8f4, #6C88C7, #4A65A0, #82a8f4);
            --success-gradient: linear-gradient(145deg, #5cb85c, #4cae4c, #449d44, #5cb85c);
            --secondary-gradient: linear-gradient(145deg, #f0f2f5, #E0E5EC, #d1d9e6, #f0f2f5);
        }

        html {
             font-size: 16px; /* Set base font size */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .neumorphic-outset {
            box-shadow: -6px -6px 12px var(--shadow-light), 6px 6px 12px var(--shadow-dark);
        }
        .neumorphic-inset {
            box-shadow: inset -4px -4px 8px var(--shadow-light), inset 4px 4px 8px var(--shadow-dark);
        }
        
        .main-container {
            border-radius: var(--radius-lg);
            padding: 2.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s ease-in-out;
            color: var(--text-color);
            position: relative;
        }
        .tab-btn.active {
            color: var(--primary-color);
            background-color: var(--bg-color);
            box-shadow: inset -3px -3px 7px var(--shadow-light), inset 3px 3px 7px var(--shadow-dark);
        }
        .tab-btn:not(.active):hover {
            color: var(--text-color-dark);
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 600;
            font-size: 0.875rem; /* 14px */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .input-group input, .input-group select {
            width: 100%;
            min-height: 44px; /* Accessibility: Tap Target */
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--bg-color);
            color: var(--text-color-dark);
            box-shadow: inset -3px -3px 7px var(--shadow-light), inset 3px 3px 7px var(--shadow-dark);
            transition: all 0.2s;
        }
        /* Accessibility: Clear focus indicators */
        .input-group input:focus-visible, .input-group select:focus-visible, .action-btn:focus-visible, .tab-btn:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: inset -2px -2px 5px var(--shadow-light), inset 2px 2px 5px var(--shadow-dark);
        }
        
        .action-btn {
            border: 1px solid var(--shadow-light);
            border-radius: var(--radius-md);
            padding: 0.75rem 2rem;
            font-weight: 700;
            transition: all 0.4s ease-in-out;
            cursor: pointer;
            box-shadow: -5px -5px 10px var(--shadow-light), 5px 5px 10px var(--shadow-dark);
            min-height: 44px; /* Accessibility: Tap Target */
            background-size: 200% 200%;
            background-position: 50% 50%;
        }
        .action-btn:hover {
            box-shadow: -3px -3px 7px var(--shadow-light), 3px 3px 7px var(--shadow-dark);
            background-position: 100% 100%;
        }
        .action-btn:active {
            box-shadow: inset -3px -3px 7px var(--shadow-light), inset 3px 3px 7px var(--shadow-dark);
        }
        .action-btn.primary {
            background-image: linear-gradient(145deg, var(--primary-light), var(--primary-color));
            color: white;
            border: 1px solid var(--primary-light);
        }
        .action-btn.primary:hover {
             background-image: var(--primary-gradient);
        }
        .action-btn.secondary {
            background-color: var(--bg-color);
            color: var(--text-color-dark);
            border: 1px solid var(--border-color);
        }
         .action-btn.secondary:hover {
            background-image: var(--secondary-gradient);
            color: var(--primary-color);
        }
        .action-btn.success {
            background-color: var(--success-color);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
        }
        .action-btn.success:hover {
             background-image: var(--success-gradient);
        }

        .player-card {
            border-radius: var(--radius-lg);
            background-color: var(--bg-color);
            box-shadow: -6px -6px 12px var(--shadow-light), 6px 6px 12px var(--shadow-dark);
            padding: 1.5rem;
        }

        .section-card {
             border-radius: var(--radius-lg);
             background: var(--bg-color);
             padding: 1.5rem;
             box-shadow: inset -4px -4px 8px var(--shadow-light), inset 4px 4px 8px var(--shadow-dark);
        }

        .remove-preview-row {
            border: none;
            border-radius: 50%;
            width: 36px;  /* Accessibility: Increased tap area */
            height: 36px; /* Accessibility: Increased tap area */
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: -2px -2px 4px var(--shadow-light), 2px 2px 4px var(--shadow-dark);
            color: var(--text-color);
        }
        .remove-preview-row:hover {
            color: #ef4444;
        }
        .remove-preview-row:active {
            box-shadow: inset -2px -2px 4px var(--shadow-light), inset 2px 2px 4px var(--shadow-dark);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .autocomplete-suggestions {
            position: absolute;
            z-index: 100;
            width: 100%;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: 0.5rem;
            box-shadow: -5px -5px 10px var(--shadow-light), 5px 5px 10px var(--shadow-dark);
        }
        .autocomplete-suggestions div { 
            padding: 0.75rem 1rem; 
            cursor: pointer; 
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 14px; /* Accessibility: Readability */
        }
        .autocomplete-suggestions div:hover { 
            background: var(--primary-light);
            color: white;
        }
        
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(46, 125, 50, 0); } }
        .pulse-green { animation: pulse-green 2s infinite; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-12">

    <div class="main-container max-w-7xl mx-auto neumorphic-outset">
        
        <!-- Header -->
        <header class="glass-card rounded-xl p-4 mb-8 flex items-center justify-between">
             <div class="flex items-center gap-4">
                <div class="w-12 h-12 flex items-center justify-center neumorphic-outset rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary-color"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><line x1="12" y1="14" x2="16" y2="14"/><line x1="12" y1="14" x2="12" y2="18"/><line x1="8" y1="10" x2="8" y2="18"/><line x1="8" y1="10" x2="12" y2="10"/></svg>
                </div>
                <h1 class="text-2xl sm:text-3xl font-extrabold text-text-color-dark">Odds Generator</h1>
             </div>
             <div class="flex items-center gap-4">
                <a href="/basketball_specials.html" class="action-btn secondary !px-4 !py-2 text-sm" aria-label="Prebaci na kalkulator za košarku">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M4.2 14.2c.627.442 1.346.734 2.14.868"/><path d="M17.66 2.34c.2.63.34 1.3.34 2.01"/><path d="M21.66 14.25c-.134.8-.426 1.519-.868 2.146"/><path d="M1.95 12c0-.71.14-1.38.34-2.01"/><path d="M9.8 2.8c-.442.627-.734 1.346-.868 2.14"/><path d="M14.25 21.66c-.8.134-1.519.426-2.146.868"/><path d="M2.34 6.34a10.02 10.02 0 0 0-1.99 4.21"/><path d="M12 22.05c.71 0 1.38-.14 2.01-.34"/><path d="M3.4 17.66c-.63-.2-1.3-.34-2.01-.34"/><path d="M2.8 9.8a10.02 10.02 0 0 0 4.21-1.99"/><path d="M22.05 12c0 .71-.14 1.38-.34 2.01"/><path d="M17.66 20.6a10.02 10.02 0 0 0 1.99-4.21"/></svg>
                    Košarka
                </a>
                <div id="status-container" class="flex items-center gap-2.5 text-sm font-medium">
                    <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500" title="Status učitavanja baze podataka"></div>
                    <span id="status-text" class="text-slate-500">Učitavanje...</span>
                </div>
             </div>
        </header>
        
        <!-- Main Content -->
        <main>
            <section id="api-section" class="section-card mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div id="api-inputs" class="space-y-4">
                        <div class="input-group">
                            <label for="competition-select">Takmičenje</label>
                            <select id="competition-select" disabled aria-label="Izaberite takmičenje"></select>
                        </div>
                        <div class="input-group">
                            <label for="event-select">Meč</label>
                            <select id="event-select" disabled aria-label="Izaberite meč"></select>
                        </div>
                    </div>
                    <div id="manual-inputs" class="hidden space-y-4">
                         <div class="input-group"><label for="manual-home-team">Domaćin</label><input type="text" id="manual-home-team"></div>
                         <div class="input-group"><label for="manual-away-team">Gost</label><input type="text" id="manual-away-team"></div>
                    </div>
                    <div class="md:col-span-2 flex flex-wrap gap-4 items-center">
                        <button type="button" id="fetch-api-btn" class="action-btn secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><path d="M18 8V2m0 6l-4-4m4 4l4-4"/><path d="M5 17v-5h8v5"/><path d="M2 17v-5h3v5"/></svg>
                            <span id="api-btn-text">Učitaj Mečeve</span>
                        </button>
                         <button type="button" id="manual-entry-btn" class="action-btn secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            <span id="manual-entry-btn-text">Ručni Unos</span>
                        </button>
                         <p id="api-status" class="text-sm text-text-color mt-2 h-5 flex-grow" aria-live="polite"></p>
                    </div>
                </div>
            </section>

             <section id="match-details-section" class="section-card grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 hidden">
                <div class="input-group md:col-span-1"><label for="match-name">Naziv Utakmice</label><input type="text" id="match-name"></div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="input-group"><label for="kickoff-date">Datum</label><input type="date" id="kickoff-date"></div>
                    <div class="input-group"><label for="kickoff-time">Vreme</label><input type="time" id="kickoff-time"></div>
                </div>
            </section>
            
            <div class="glass-card rounded-xl p-2 mb-8" role="tablist" aria-label="Glavna navigacija">
                <nav class="flex items-center justify-center gap-2">
                    <button class="tab-btn active" data-tab="players" role="tab" aria-selected="true" aria-controls="tab-players">Igrači</button>
                    <button class="tab-btn" data-tab="specials" role="tab" aria-selected="false" aria-controls="tab-specials">Specijal</button>
                </nav>
            </div>

            <div id="tab-players" class="tab-content active" role="tabpanel" aria-labelledby="tab-players-btn">
                <form id="odds-form">
                     <section class="section-card grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                         <div class="input-group">
                            <label for="team-select">Tim</label>
                            <select id="team-select" disabled></select>
                        </div>
                        <div class="input-group"><label for="team-win-odd">Kvota na Pobedu</label><input type="number" id="team-win-odd" step="0.01" value="1.85"></div>
                        <div class="input-group"><label for="bookmaker-margin">Margina (%)</label><input type="number" id="bookmaker-margin" step="0.1" value="10"></div>
                        <div id="team-injury-display" class="md:col-span-3" style="display: none;"></div>
                        <div id="team-lineup-display" class="md:col-span-3" style="display: none;"></div>
                    </section>
                     <section>
                        <div id="players-section-header" class="flex flex-wrap justify-between items-center gap-4 mb-6">
                            <h2 class="text-2xl font-bold text-text-color-dark">Podešavanja Igrača</h2>
                            <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                                <div id="api-player-adder" class="input-group flex-grow hidden">
                                    <label for="api-player-select">Dodaj iz ponude</label>
                                    <div class="flex items-center gap-2">
                                        <select id="api-player-select" class="flex-grow"></select>
                                        <button type="button" id="add-api-player-btn" class="action-btn secondary !p-3 flex-shrink-0" title="Dodaj izabranog igrača" aria-label="Dodaj izabranog igrača iz ponude">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="input-group flex-grow">
                                    <label for="team-filter">Filtriraj po timu</label>
                                    <select id="team-filter"></select>
                                </div>
                            </div>
                        </div>
                        <div id="players-container" class="space-y-8"></div>
                    </section>
                    <div class="flex justify-center mt-8 mb-8">
                        <button type="button" id="add-player-btn" class="action-btn secondary gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            Dodaj Igrača Ručno
                        </button>
                    </div>
                </form>
            </div>

            <div id="tab-specials" class="tab-content" role="tabpanel" aria-labelledby="tab-specials-btn">
                <form id="specials-form">
                     <section class="section-card mb-8">
                        <h2 class="text-2xl font-bold text-text-color-dark mb-6">Parametri za Specijal</h2>
                         <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <div class="input-group"><label for="special-goals-lambda">Oč. Golova (λ)</label><input type="number" id="special-goals-lambda" step="0.1" value="2.5"></div>
                            <div class="input-group"><label for="special-goals-lambda-home">Oč. Golova Domaćin</label><input type="number" id="special-goals-lambda-home" step="0.1" value="1.4" readonly></div>
                            <div class="input-group"><label for="special-goals-lambda-away">Oč. Golova Gost</label><input type="number" id="special-goals-lambda-away" step="0.1" value="1.1" readonly></div>
                             <div class="input-group"><label for="special-corners-lambda">Oč. Kornera (λ)</label><input type="number" id="special-corners-lambda" step="0.1" value="10.5"></div>
                            <div class="input-group"><label for="special-cards-lambda">Oč. Kartona (λ)</label><input type="number" id="special-cards-lambda" step="0.1" value="4.5"></div>
                             <div class="input-group"><label for="special-sot-lambda">Oč. Šuteva u Okvir (λ)</label><input type="number" id="special-sot-lambda" step="0.1" value="8.5"></div>
                            <div class="input-group"><label for="special-corners-lambda-home">Oč. Kornera Domaćin</label><input type="number" id="special-corners-lambda-home" step="0.1" value="5.5" readonly></div>
                            <div class="input-group"><label for="special-corners-lambda-away">Oč. Kornera Gost</label><input type="number" id="special-corners-lambda-away" step="0.1" value="5.0" readonly></div>
                            <div class="input-group"><label for="special-gg-prob">GG Verovatnoća (%)</label><input type="number" id="special-gg-prob" step="0.1" value="55.0"></div>
                            <div class="input-group"><label for="special-penalty-odd">Kvota za Penal</label><input type="number" id="special-penalty-odd" step="0.01" value="3.0"></div>
                            <div class="input-group"><label for="special-red-card-odd">Kvota za Crveni Karton</label><input type="number" id="special-red-card-odd" step="0.01" value="4.0"></div>
                         </div>
                    </section>
                     <section class="section-card mb-8">
                        <h3 class="text-xl font-bold text-text-color-dark mb-4">Dodaj Prilagođenu Igru</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div class="input-group"><label for="custom-market2">Opis 1</label><input type="text" id="custom-market2" placeholder="Npr. GG"></div>
                            <div class="input-group"><label for="custom-market3">Opis 2</label><input type="text" id="custom-market3" placeholder="Npr. i 3+"></div>
                            <div class="input-group"><label for="custom-odd">Kvota</label><input type="number" id="custom-odd" step="0.01" placeholder="Npr. 1.85"></div>
                            <button type="button" id="add-custom-bet-btn" class="action-btn secondary h-12">Dodaj</button>
                        </div>
                    </section>
                </form>
            </div>

            <div class="flex flex-col md:flex-row justify-center items-center gap-6 my-10">
                <button id="generate-btn" class="action-btn primary w-full md:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                    <span id="generate-btn-text">Generiši Kvote</span>
                </button>
                <button type="button" id="reset-btn" class="action-btn secondary w-full md:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    Poništi Unos
                </button>
            </div>

            <div id="preview-section" class="hidden section-card" aria-live="polite">
                <h2 class="text-2xl font-bold text-text-color-dark mb-6 text-center">Pregled Generisanih Kvota</h2>
                 <div class="glass-card rounded-lg p-3 flex flex-wrap items-center justify-between gap-4 mb-4">
                    <div class="input-group !mb-0"><input type="text" id="csv-match-name" placeholder="MATCH_NAME" class="!py-2 !text-sm" aria-label="Naziv meča za CSV"></div>
                    <div class="input-group !mb-0"><input type="text" id="csv-league-name" placeholder="LEAGUE_NAME" class="!py-2 !text-sm" aria-label="Naziv lige za CSV"></div>
                 </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="border-b-2 border-white/50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-text-color uppercase tracking-wider">Igrač / Igra</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-text-color uppercase tracking-wider">Opis 1</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-text-color uppercase tracking-wider">Opis 2</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-text-color uppercase tracking-wider">Kvota</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-text-color uppercase tracking-wider">Ukloni</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body"></tbody>
                    </table>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="download-csv-btn" class="action-btn success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg>
                        Preuzmi CSV
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- SCRIPT - ALL FUNCTIONALITY REMAINS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);
            const on = (element, event, handler) => element.addEventListener(event, handler);

            // New functions for expected goals calculation
// ... existing code ... -->
                return [homeExpectedGoals, awayExpectedGoals];
            }

            const calculateTeamLambdas = (event) => {
                const matchOddsMarket = event.markets?.['soccer.match_odds']?.submarkets?.['period=ft']?.selections;
                const totalGoalsMarket = event.markets?.['soccer.total_goals']?.submarkets?.['period=ft']?.selections;

                if (!matchOddsMarket || !totalGoalsMarket) {
                    return { lambdaHome: null, lambdaAway: null };
                }

                const homeOdd = matchOddsMarket.find(s => s.outcome === 'home')?.price;
                const awayOdd = matchOddsMarket.find(s => s.outcome === 'away')?.price;

                const overPrice = totalGoalsMarket.find(s => s.params === 'total=2.5' && s.outcome === 'over')?.price;
                const underPrice = totalGoalsMarket.find(s => s.params === 'total=2.5' && s.outcome === 'under')?.price;
                
                if (!homeOdd || !awayOdd || !overPrice || !underPrice) {
                     return { lambdaHome: null, lambdaAway: null };
                }

                const [homeExpectedGoals, awayExpectedGoals] = expectedGoals(overPrice, underPrice, homeOdd, awayOdd);

                return { lambdaHome: homeExpectedGoals, lambdaAway: awayExpectedGoals };
            };
            
            // DOM Element Constants
            const manualEntryBtn = $('#manual-entry-btn');
            const manualEntryBtnText = $('#manual-entry-btn-text');
// ... existing code ... -->
            on(fetchApiBtn, 'click', fetchApiEvents);
            on(competitionSelect, 'change', e => populateEventSelect(e.target.value));
            on(eventSelect, 'change', e => populateMatchData(e.target.value));
            
            on(teamSelect, 'change', e => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const odd = selectedOption.dataset.odd;
                if (odd) $('#team-win-odd').value = odd;
                const teamName = selectedOption.textContent;

                // FIX 1: Update Match Name
                if (selectedOption.value !== 'all') {
                    $('#match-name').value = teamName;
                } else {
                    const event = apiEvents.find(e => e.id == eventSelect.value);
                    if (event) {
                        $('#match-name').value = `${event.home.name} vs ${event.away.name}`;
                    }
                }

                // FIX 2: Filter API Player Dropdown
                const selectedTeamSide = e.target.value;
                const playersToDisplay = selectedTeamSide === 'all' 
                    ? availableApiPlayers 
                    : availableApiPlayers.filter(p => p.teamSide === selectedTeamSide);
                populateApiPlayerSelect(playersToDisplay);


                // Existing injury/lineup logic
                const injuryContainer = $('#team-injury-display');
                if (teamName && teamName !== 'all' && window.injuryManager) {
                    injuryContainer.style.display = 'block';
                    window.injuryManager.displayInjuries(teamName, 'team-injury-display');
                } else {
                    injuryContainer.style.display = 'none';
                }
                const lineupContainer = $('#team-lineup-display');
                if (teamName && teamName !== 'all' && window.lineupManager) {
                    lineupContainer.style.display = 'block';
                    window.lineupManager.displayLineup(teamName, 'team-lineup-display');
                } else {
                    lineupContainer.style.display = 'none';
                }
            });

            on(addApiPlayerBtn, 'click', () => {
                const selectedOption = apiPlayerSelect.options[apiPlayerSelect.selectedIndex];
                if (!selectedOption || !selectedOption.value) return;
// ... existing code ... -->

